<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>typecho 源码分析：4、Database — zqhong</title>
	<meta name="description" content="Title: typecho 源码分析：4、Database; Date: 2016-03-04; Author: zqhong">
	<meta name="author" content="zqhong">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
		<script src="/theme/html5.js"></script>
		<![endif]-->
	<link href="/theme/css/ipython.css" rel="stylesheet">
	<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
	<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
	<link href="//maxcdn.bootstrapcdn.com/bootswatch/3.2.0/simplex/bootstrap.min.css" rel="stylesheet">
	<link href="/theme/css/local.css" rel="stylesheet">
	<link href="/theme/css/pygments.css" rel="stylesheet">
</head>
<body>
<div class="container">
	<div class="page-header">
		<h1><a href="/">zqhong</a>
			<br><small>Simplicity is the ultimate sophistication</small></h1>	</div>
	<div class="row">
		<div class="col-md-8 col-md-offset-2">
<div class="article" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="text-center article-header">
		<h1 itemprop="name headline" class="article-title">typecho 源码分析：4、Database</h1>
		<span itemprop="author" itemscope itemtype="http://schema.org/Person">
			<h4 itemprop="name">zqhong</h4>
		</span>
		<time datetime="2016-03-04T11:46:00+08:00" itemprop="datePublished">Fri 04 March 2016</time>
	</div>
	<div>
		Category:
		<span itemprop="articleSection">
			<a href="/category/php.html" rel="category">PHP</a>
		</span>
	</div>
 
	<div>
		Tags:
		<span itemprop="keywords">
			<a href="/tag/typecho.html" rel="tag">typecho</a>
		</span>
		<span itemprop="keywords">
			<a href="/tag/php.html" rel="tag">php</a>
		</span>
		<span itemprop="keywords">
			<a href="/tag/database.html" rel="tag">database</a>
		</span>
	</div>
	<div itemprop="articleBody" class="article-body"><h3>Typecho_Db</h3>
<p>Typecho 没有 Model 层，采用自建的 DB 类帮助开发者快速获取自己需要的数据。</p>
<h4>一、初始化数据库</h4>
<p><em>config.inc.php</em></p>
<div class="highlight"><pre><span></span><span class="x"># 这里的配置文件只作为参考，可能和你自己的配置文件有出入。</span>
<span class="x">$db = new Typecho_Db(&#39;Pdo_Mysql&#39;, &#39;typecho_&#39;);</span>
<span class="x">$db-&gt;addServer(array (</span>
<span class="x">  &#39;host&#39; =&gt; &#39;localhost&#39;,</span>
<span class="x">  &#39;user&#39; =&gt; &#39;username&#39;,</span>
<span class="x">  &#39;charset&#39; =&gt; &#39;utf8&#39;,</span>
<span class="x">  &#39;port&#39; =&gt; &#39;password&#39;,</span>
<span class="x">  &#39;database&#39; =&gt; &#39;typecho&#39;,</span>
<span class="x">), Typecho_Db::READ | Typecho_Db::WRITE);</span>
<span class="x">Typecho_Db::set($db);</span>
</pre></div>


<p><em>typecho/var/Typecho/Db.php</em></p>
<div class="highlight"><pre><span></span><span class="x">class Typecho_Db</span>
<span class="x">{</span>
<span class="x">    private static $_instance;</span>

<span class="x">    public function __construct($adapterName, $prefix = &#39;typecho_&#39;)</span>
<span class="x">    {</span>
<span class="x">        /** 获取适配器名称 */</span>
<span class="x">        $this-&gt;_adapterName = $adapterName;</span>

<span class="x">        /** 数据库适配器 */</span>
<span class="x">        $adapterName = &#39;Typecho_Db_Adapter_&#39; . $adapterName;</span>

<span class="x">        if (!call_user_func(array($adapterName, &#39;isAvailable&#39;))) {</span>
<span class="x">            throw new Typecho_Db_Exception(&quot;Adapter {$adapterName} is not available&quot;);</span>
<span class="x">        }</span>

<span class="x">        $this-&gt;_prefix = $prefix;</span>

<span class="x">        /** 初始化内部变量 */</span>
<span class="x">        $this-&gt;_pool = array();</span>
<span class="x">        $this-&gt;_connectedPool = array();</span>
<span class="x">        $this-&gt;_config = array();</span>

<span class="x">        //实例化适配器对象</span>
<span class="x">        $this-&gt;_adapter = new $adapterName();</span>
<span class="x">    }</span>

<span class="x">    public function addServer($config, $op)</span>
<span class="x">    {</span>
<span class="x">        $this-&gt;_config[] = Typecho_Config::factory($config);</span>
<span class="x">        $key = count($this-&gt;_config) - 1;</span>

<span class="x">        /** 将连接放入池中 */</span>
<span class="x">        switch ($op) {</span>
<span class="x">            case self::READ:</span>
<span class="x">            case self::WRITE:</span>
<span class="x">                $this-&gt;_pool[$op][] = $key;</span>
<span class="x">                break;</span>
<span class="x">            default:</span>
<span class="x">                $this-&gt;_pool[self::READ][] = $key;</span>
<span class="x">                $this-&gt;_pool[self::WRITE][] = $key;</span>
<span class="x">                break;</span>
<span class="x">        }</span>
<span class="x">    }</span>

<span class="x">    public static function get()</span>
<span class="x">    {</span>
<span class="x">        if (empty(self::$_instance)) {</span>
<span class="x">            /** Typecho_Db_Exception */</span>
<span class="x">            throw new Typecho_Db_Exception(&#39;Missing Database Object&#39;);</span>
<span class="x">        }</span>

<span class="x">        return self::$_instance;</span>
<span class="x">    }</span>

<span class="x">    public static function set(Typecho_Db $db)</span>
<span class="x">    {</span>
<span class="x">        self::$_instance = $db;</span>
<span class="x">    }</span>
<span class="x">}</span>
</pre></div>


<p>代码分析：
1. 初始化内部变量（<code>$this-&gt;_pool, $this-&gt;_connectedPool、$this-&gt;_config</code>）和实例化适配器对象,这里的适配器对象为：<em>Typecho_Db_Adapter_Pdo_Mysql</em>（<code>$this-&gt;_adapter</code>）。
2. 添加配置信息到 <code>$this-&gt;_config</code> 中。然后，将配置信息在 <code>$this-&gt;_config</code> 中的 key 保存到对应的连接池中。（这里假设数据库操作为读，<code>$this-&gt;_pool[self::READ][] = $key</code>）
3. 最后，将实例化后的 Typecho_Db 对象保存在 <code>Typecho_Db::$_instance</code> 中。</p>
<blockquote>
<p>备注：上面的 <em>$this</em> 指的是 Typecho_Db 实例对象</p>
</blockquote>
<hr />
<!--more-->

<h4>二、Typecho如何实现数据库查询</h4>
<div class="highlight"><pre><span></span><span class="x">$db = Typecho_Db::get();</span>
<span class="x">$select = $db-&gt;select()-&gt;from(&quot;table.options&quot;)-&gt;where(&quot;user = 0&quot;);</span>
<span class="x">$result = $db-&gt;fetchAll($select);</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="x">class Typecho_Db</span>
<span class="x">{</span>
<span class="x">    private static $_instance;</span>

<span class="x">    public static function get()</span>
<span class="x">    {</span>
<span class="x">        if (empty(self::$_instance)) {</span>
<span class="x">            /** Typecho_Db_Exception */</span>
<span class="x">            throw new Typecho_Db_Exception(&#39;Missing Database Object&#39;);</span>
<span class="x">        }</span>

<span class="x">        return self::$_instance;</span>
<span class="x">    }</span>

<span class="x">    public function sql()</span>
<span class="x">    {</span>
<span class="x">        return new Typecho_Db_Query($this-&gt;_adapter, $this-&gt;_prefix);</span>
<span class="x">    }</span>

<span class="x">    public function select()</span>
<span class="x">    {</span>
<span class="x">        $args = func_get_args();</span>
<span class="x">        return call_user_func_array(array($this-&gt;sql(), &#39;select&#39;), $args ? $args : array(&#39;*&#39;));</span>
<span class="x">    }</span>

<span class="x">    public function query($query, $op = self::READ, $action = self::SELECT)</span>
<span class="x">    {</span>
<span class="x">        /** 在适配器中执行查询 */</span>
<span class="x">        if ($query instanceof Typecho_Db_Query) {</span>
<span class="x">            $action = $query-&gt;getAttribute(&#39;action&#39;);</span>
<span class="x">            $op = (self::UPDATE == $action || self::DELETE == $action</span>
<span class="x">            || self::INSERT == $action) ? self::WRITE : self::READ;</span>
<span class="x">        } else if (!is_string($query)) {</span>
<span class="x">            /** 如果query不是对象也不是字符串,那么将其判断为查询资源句柄,直接返回 */</span>
<span class="x">            return $query;</span>
<span class="x">        }</span>

<span class="x">        /** 选择连接池 */</span>
<span class="x">        $handle = $this-&gt;selectDb($op);</span>

<span class="x">        /** 提交查询 */</span>
<span class="x">        $resource = $this-&gt;_adapter-&gt;query($query, $handle, $op, $action);</span>

<span class="x">        if ($action) {</span>
<span class="x">            //根据查询动作返回相应资源</span>
<span class="x">            switch ($action) {</span>
<span class="x">                case self::UPDATE:</span>
<span class="x">                case self::DELETE:</span>
<span class="x">                    return $this-&gt;_adapter-&gt;affectedRows($resource, $handle);</span>
<span class="x">                case self::INSERT:</span>
<span class="x">                    return $this-&gt;_adapter-&gt;lastInsertId($resource, $handle);</span>
<span class="x">                case self::SELECT:</span>
<span class="x">                default:</span>
<span class="x">                    return $resource;</span>
<span class="x">            }</span>
<span class="x">        } else {</span>
<span class="x">            //如果直接执行查询语句则返回资源</span>
<span class="x">            return $resource;</span>
<span class="x">        }</span>
<span class="x">    }</span>

<span class="x">    public function selectDb($op)</span>
<span class="x">    {</span>
<span class="x">        if (!isset($this-&gt;_connectedPool[$op])) {</span>
<span class="x">            if (empty($this-&gt;_pool[$op])) {</span>
<span class="x">                /** Typecho_Db_Exception */</span>
<span class="x">                throw new Typecho_Db_Exception(&#39;Missing Database Connection&#39;);</span>
<span class="x">            }</span>

<span class="x">            //获取相应读或写服务器连接池中的一个</span>
<span class="x">            $selectConnection = rand(0, count($this-&gt;_pool[$op]) - 1);</span>
<span class="x">            //获取随机获得的连接池配置</span>
<span class="x">            $selectConnectionConfig = $this-&gt;_config[$this-&gt;_pool[$op][$selectConnection]];</span>
<span class="x">            $selectConnectionHandle = $this-&gt;_adapter-&gt;connect($selectConnectionConfig);</span>
<span class="x">            $this-&gt;_connectedPool[$op] = &amp;$selectConnectionHandle;</span>

<span class="x">        }</span>

<span class="x">        return $this-&gt;_connectedPool[$op];</span>
<span class="x">    }</span>

<span class="x">    public function fetchAll($query, array $filter = NULL)</span>
<span class="x">    {</span>
<span class="x">        //执行查询</span>
<span class="x">        $resource = $this-&gt;query($query, self::READ);</span>
<span class="x">        $result = array();</span>

<span class="x">        /** 取出过滤器 */</span>
<span class="x">        if (!empty($filter)) {</span>
<span class="x">            list($object, $method) = $filter;</span>
<span class="x">        }</span>

<span class="x">        //取出每一行</span>
<span class="x">        while ($rows = $this-&gt;_adapter-&gt;fetch($resource)) {</span>
<span class="x">            //判断是否有过滤器</span>
<span class="x">            $result[] = $filter ? call_user_func(array(&amp;$object, $method), $rows) : $rows;</span>
<span class="x">        }</span>

<span class="x">        return $result;</span>
<span class="x">    }</span>
<span class="x">}</span>

<span class="x">class Typecho_Db_Query</span>
<span class="x">{</span>
<span class="x">    public function select($field = &#39;*&#39;)</span>
<span class="x">    {</span>
<span class="x">        $this-&gt;_sqlPreBuild[&#39;action&#39;] = Typecho_Db::SELECT;</span>
<span class="x">        $args = func_get_args();</span>

<span class="x">        $this-&gt;_sqlPreBuild[&#39;fields&#39;] = $this-&gt;getColumnFromParameters($args);</span>
<span class="x">        return $this;</span>
<span class="x">    }</span>

<span class="x">    public function from($table)</span>
<span class="x">    {</span>
<span class="x">        $this-&gt;_sqlPreBuild[&#39;table&#39;] = $this-&gt;filterPrefix($table);</span>
<span class="x">        return $this;</span>
<span class="x">    }</span>

<span class="x">    public function where()</span>
<span class="x">    {</span>
<span class="x">        $condition = func_get_arg(0);</span>
<span class="x">        $condition = str_replace(&#39;?&#39;, &quot;%s&quot;, $this-&gt;filterColumn($condition));</span>
<span class="x">        $operator = empty($this-&gt;_sqlPreBuild[&#39;where&#39;]) ? &#39; WHERE &#39; : &#39; AND&#39;;</span>

<span class="x">        if (func_num_args() &lt;= 1) {</span>
<span class="x">            $this-&gt;_sqlPreBuild[&#39;where&#39;] .= $operator . &#39; (&#39; . $condition . &#39;)&#39;;</span>
<span class="x">        } else {</span>
<span class="x">            $args = func_get_args();</span>
<span class="x">            array_shift($args);</span>
<span class="x">            $this-&gt;_sqlPreBuild[&#39;where&#39;] .= $operator . &#39; (&#39; . vsprintf($condition, $this-&gt;quoteValues($args)) . &#39;)&#39;;</span>
<span class="x">        }</span>

<span class="x">        return $this;</span>
<span class="x">    }</span>

<span class="x">    public function __toString()</span>
<span class="x">    {</span>
<span class="x">        switch ($this-&gt;_sqlPreBuild[&#39;action&#39;]) {</span>
<span class="x">            case Typecho_Db::SELECT:</span>
<span class="x">                return $this-&gt;_adapter-&gt;parseSelect($this-&gt;_sqlPreBuild);</span>
<span class="x">            case Typecho_Db::INSERT:</span>
<span class="x">                return &#39;INSERT INTO &#39;</span>
<span class="x">                . $this-&gt;_sqlPreBuild[&#39;table&#39;]</span>
<span class="x">                . &#39;(&#39; . implode(&#39; , &#39;, array_keys($this-&gt;_sqlPreBuild[&#39;rows&#39;])) . &#39;)&#39;</span>
<span class="x">                . &#39; VALUES &#39;</span>
<span class="x">                . &#39;(&#39; . implode(&#39; , &#39;, array_values($this-&gt;_sqlPreBuild[&#39;rows&#39;])) . &#39;)&#39;</span>
<span class="x">                . $this-&gt;_sqlPreBuild[&#39;limit&#39;];</span>
<span class="x">            case Typecho_Db::DELETE:</span>
<span class="x">                return &#39;DELETE FROM &#39;</span>
<span class="x">                . $this-&gt;_sqlPreBuild[&#39;table&#39;]</span>
<span class="x">                . $this-&gt;_sqlPreBuild[&#39;where&#39;];</span>
<span class="x">            case Typecho_Db::UPDATE:</span>
<span class="x">                $columns = array();</span>
<span class="x">                if (isset($this-&gt;_sqlPreBuild[&#39;rows&#39;])) {</span>
<span class="x">                    foreach ($this-&gt;_sqlPreBuild[&#39;rows&#39;] as $key =&gt; $val) {</span>
<span class="x">                        $columns[] = &quot;$key = $val&quot;;</span>
<span class="x">                    }</span>
<span class="x">                }</span>

<span class="x">                return &#39;UPDATE &#39;</span>
<span class="x">                . $this-&gt;_sqlPreBuild[&#39;table&#39;]</span>
<span class="x">                . &#39; SET &#39; . implode(&#39; , &#39;, $columns)</span>
<span class="x">                . $this-&gt;_sqlPreBuild[&#39;where&#39;];</span>
<span class="x">            default:</span>
<span class="x">                return NULL;</span>
<span class="x">        }</span>
<span class="x">    }</span>
<span class="x">}</span>
</pre></div>


<p>代码分析：
1. 获取数据库对象实例（<code>Typecho_Db::get()</code>）
2. 使用 <em>Typecho_Db_Query</em> 构造 SQL 语句。其中 <code>$db-&gt;select()</code> 返回 <em>Typecho_Db_Query</em> 实例化对象。
3. 执行查询操作</p>
<p>如果对这部分有兴趣，请深入代码了解。</p>
<h3>相关资料</h3>
<p><a href="http://docs.typecho.org/develop/db">typecho 设计文档 - database</a></p></div>
	<hr>
	<h2>Comments</h2>
</div>
		</div>
	</div> 	<!-- <hr> -->
</div> <!-- /container -->
<footer class="aw-footer bg-danger">
	<div class="container"> <!-- footer -->
		<div class="row">
			<div class="col-md-10 col-md-offset-1">
				<div class="row">
					<div class="col-md-3">
						<h4>Navigation</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="">zqhong</a></li>
						</ul>
					</div>
					<div class="col-md-3">
						<h4>Author</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="#">You can add links in your config file</a></li>
							<li><a href="#">Another social link</a></li>
						</ul>
					</div>
					<div class="col-md-3">
						<h4>Categories</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="/category/PHP.html">PHP (7)</a></li>
							<li><a href="/category/Python.html">Python (2)</a></li>
							<li><a href="/category/Python,-WEB.html">Python, WEB (1)</a></li>
							<li><a href="/category/WEB.html">WEB (2)</a></li>
						</ul>
					</div>
					<div class="col-md-3">
						<h4>Links</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="http://getpelican.com/">Pelican</a></li>
							<li><a href="http://python.org/">Python.org</a></li>
							<li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
							<li><a href="#">You can modify those links in your config file</a></li>
						</ul>
					</div>
				</div>
			</div>
		</div>
	</div>
</footer>
<div class="container">
	<div class="row">
		<div class="col-md-12 text-center center-block aw-bottom">
			<p>&copy; zqhong 2014</p>
			<p>Powered by Pelican</p>
		</div>
	</div>
</div>
<!-- JavaScript -->
<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
<script type="text/javascript">
jQuery(document).ready(function($) {
	$("div.collapseheader").click(function () {
		$header = $(this).children("span").first();
		$codearea = $(this).children(".input_area");
		$codearea.slideToggle(500, function () {
			$header.text(function () {
				return $codearea.is(":visible") ? "Collapse Code" : "Expand Code";
			});
		});
	});
});
</script>
</body>
</html>